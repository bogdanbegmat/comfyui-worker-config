# 1. Start from a SPECIFIC version of the official worker to ensure stability.
FROM runpod/worker-comfyui:5.3.0-base

# 2. Install git, which we need for cloning.
#    We switch to the root user to install packages, then back to the default user.
USER root
RUN apt-get update && apt-get install -y git && rm -rf /var/lib/apt/lists/*
USER 1000

# 3. Set the working directory to where custom nodes should live.
WORKDIR /comfyui/custom_nodes

# 4. Copy our list of repositories into a temporary location.
COPY git_clones.txt /tmp/git_clones.txt

# 5. Read the file line-by-line and clone each repository.
#    This loop also handles optional commit hashes for version pinning.
RUN while IFS=',' read -r repo_url commit_hash; do \
      # Trim leading/trailing whitespace
      repo_url=$(echo "$repo_url" | xargs) \
      commit_hash=$(echo "$commit_hash" | xargs) \
      # Clone the repository
      git clone "$repo_url"; \
      # If a commit hash is provided, check out that specific version
      if [ -n "$commit_hash" ]; then \
        echo "Checking out commit $commit_hash for $repo_url"; \
        (cd "$(basename "$repo_url" .git)" && git checkout "$commit_hash"); \
      fi; \
    done < /tmp/git_clones.txt

# 6. Install all Python dependencies found in the cloned repos.
#    This command finds every requirements.txt, concatenates them,
#    removes duplicates, and installs them all in one go.
RUN --mount=type=cache,target=/root/.cache/pip \
    pip install -r <(find . -name 'requirements.txt' -exec cat {} + | sort -u) --use-feature=fast-deps

# 7. Reset the working directory and set up the final startup script.
WORKDIR /comfyui
COPY startup.sh /usr/local/bin/startup.sh
RUN chmod +x /usr/local/bin/startup.sh
ENV STARTUP_SCRIPT="/usr/local/bin/startup.sh"
